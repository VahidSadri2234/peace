<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>طراحی فلو تیکت در سا۲</title>
  <style>
    :root {
      --bg: #f4f6f9;
      --card: #ffffff;
      --muted: #6b7280;
      --border: #e5e7eb;
      --accent: #2563eb;
      --accent-soft: #e0ebff;
      --disabled: #f1f5f9;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 32px;
      background: var(--bg);
      font-family: "Vazirmatn", "Segoe UI", sans-serif;
      color: #0f172a;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 16px 30px rgba(15, 23, 42, 0.08);
      padding: 28px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .header h1 {
      margin: 0;
      font-size: 24px;
    }

    .header p {
      margin: 6px 0 0;
      color: var(--muted);
    }

    .main {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 18px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.05);
    }

    .card h3 {
      margin: 0 0 12px;
      font-size: 16px;
    }

    .step-list .step-item {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .step-list .step-item.active {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: #1d4ed8;
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.12);
    }

    .muted { color: var(--muted); font-size: 13px; }

    label { font-weight: 600; display: block; margin-bottom: 6px; }

    input[type="text"], select, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-family: inherit;
      font-size: 14px;
    }

    select[multiple] { min-height: 120px; }

    .row { margin-bottom: 14px; }

    .hint { color: var(--muted); font-size: 13px; margin-top: 6px; }

    .radio-group { display: flex; gap: 16px; flex-wrap: wrap; }

    .radio-item { display: flex; align-items: center; gap: 6px; font-weight: 600; }

    .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }

    .section-card {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      margin-top: 10px;
      background: #f8fafc;
    }

    .strategy-card { margin-top: 12px; }

    .hidden { display: none; }

    .checkbox { display: flex; align-items: center; gap: 8px; font-weight: 600; }

    .placeholder {
      background: var(--disabled);
      border: 1px dashed var(--border);
      color: var(--muted);
    }

    .preview {
      background: #0f172a;
      color: #e2e8f0;
      border-radius: 12px;
      padding: 12px;
      font-size: 13px;
      overflow: auto;
    }

    @media (max-width: 1000px) {
      .main { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>طراحی فلو تیکت در سا۲</h1>
      <p>در این صفحه می‌توانید مرحله‌های یک فلو را تعریف و تنظیمات هر مرحله را مدیریت کنید.</p>
    </header>

    <div class="main">
      <aside>
        <div class="card">
          <h3>تنظیمات کلی فلو</h3>
          <div class="row">
            <label for="flow_name">نام فلو</label>
            <input type="text" id="flow_name" name="flow_name" placeholder="مثال: فلو پیش‌فرض تیکت‌های شهرداری">
            <div class="hint">سایر تنظیمات کلی فلو (SLA پیش‌فرض، سیاست بازگشایی، قوانین امتیازدهی کلی و غیره) بعداً اضافه می‌شوند.</div>
          </div>
        </div>

        <div class="card step-list">
          <h3>مرحله‌ها (Steps)</h3>
          <div class="step-item" data-step="step_customer">انتخاب کارفرما</div>
          <div class="step-item" data-step="step_service">انتخاب سرویس</div>
          <div class="step-item" data-step="step_work">انجام کار</div>
          <div class="step-item" data-step="step_delivery">تحویل به کارفرما</div>
        </div>
      </aside>

      <section>
        <div class="card">
          <h3>تنظیمات مرحله‌ی انتخاب‌شده</h3>
          <div class="muted" id="selected_step_label">مرحله: انتخاب کارفرما</div>

          <div class="section-card">
            <h4>استراتژی ارجاع تیکت</h4>

            <div class="row">
              <label for="strategy_type">نوع استراتژی ارجاع</label>
              <select id="strategy_type" name="strategy_type">
                <option value="single">کارتابل واحد (Single)</option>
                <option value="round_robin">چرخشی (Round Robin)</option>
                <option value="self_service">سلف‌سرویس (Self Service)</option>
                <option value="multi_send">ارسال همزمان به چند نفر (Multi Send)</option>
              </select>
              <div class="hint">تعیین می‌کند کار این استپ با چه الگویی بین افراد پخش شود.</div>
            </div>

            <div class="row">
              <label>منبع کاندیداها</label>
              <div class="radio-group" id="candidate_source_group">
                <label class="radio-item"><input type="radio" name="candidate_source_type" value="users" checked> کاربران (Users)</label>
                <label class="radio-item"><input type="radio" name="candidate_source_type" value="roles"> نقش‌ها (Roles)</label>
                <label class="radio-item"><input type="radio" name="candidate_source_type" value="users_and_roles"> ترکیبی (Users + Roles)</label>
              </div>
              <div class="hint">مشخص می‌کند لیست کاندیداها از چه منبعی پر شود.</div>
            </div>

            <div class="grid-2 row">
              <div>
                <label for="candidate_users">لیست کاربران کاندیدا</label>
                <select id="candidate_users" name="candidate_users" multiple>
                  <option value="کاربر نمونه ۱">کاربر نمونه ۱</option>
                  <option value="کاربر نمونه ۲">کاربر نمونه ۲</option>
                  <option value="کاربر نمونه ۳">کاربر نمونه ۳</option>
                </select>
              </div>
              <div>
                <label for="candidate_roles">لیست نقش‌های کاندیدا</label>
                <select id="candidate_roles" name="candidate_roles" multiple>
                  <option value="پشتیبان فنی">پشتیبان فنی</option>
                  <option value="کارشناس شهرسازی">کارشناس شهرسازی</option>
                  <option value="کارشناس درآمد">کارشناس درآمد</option>
                </select>
              </div>
            </div>

            <div class="strategy-card" data-strategy="single">
              <h4>تنظیمات کارتابل واحد (Single)</h4>
              <div class="row">
                <label for="single_assignment_mode">روش انتخاب مسئول</label>
                <select id="single_assignment_mode" name="single_assignment_mode">
                  <option value="fixed_user">کاربر ثابت</option>
                  <option value="first_user_in_pool">اولین کاربر لیست کاندیداها</option>
                </select>
                <div class="hint">مشخص می‌کند مسئول این استپ همیشه فرد مشخص باشد یا اولین نفر لیست.</div>
              </div>
              <div class="row">
                <label for="single_fixed_user_id">کاربر ثابت</label>
                <select id="single_fixed_user_id" name="single_fixed_user_id">
                  <option value="">انتخاب کنید</option>
                  <option value="کاربر نمونه ۱">کاربر نمونه ۱</option>
                  <option value="کاربر نمونه ۲">کاربر نمونه ۲</option>
                </select>
                <div class="hint">فقط وقتی روش انتخاب = «کاربر ثابت» است استفاده می‌شود.</div>
              </div>
            </div>

            <div class="strategy-card hidden" data-strategy="round_robin">
              <h4>تنظیمات چرخشی (Round Robin)</h4>
              <div class="row">
                <label for="rr_pool_users">لیست کاربران چرخشی</label>
                <select id="rr_pool_users" name="rr_pool_users" multiple>
                  <option value="کاربر نمونه ۱">کاربر نمونه ۱</option>
                  <option value="کاربر نمونه ۲">کاربر نمونه ۲</option>
                  <option value="کاربر نمونه ۳">کاربر نمونه ۳</option>
                </select>
                <div class="hint">اگر خالی باشد، از لیست کاربران کاندیدا استفاده می‌شود.</div>
              </div>
              <div class="row">
                <label for="rr_order_mode">الگوریتم انتخاب نفر بعد</label>
                <select id="rr_order_mode" name="rr_order_mode">
                  <option value="list_order">بر اساس ترتیب لیست</option>
                  <option value="least_recent">کمترین دریافت اخیر</option>
                </select>
              </div>
            </div>

            <div class="strategy-card hidden" data-strategy="self_service">
              <h4>تنظیمات سلف‌سرویس</h4>
              <div class="row">
                <label for="ss_pool_users">لیست کاربران سلف‌سرویس</label>
                <select id="ss_pool_users" name="ss_pool_users" multiple>
                  <option value="کاربر نمونه ۱">کاربر نمونه ۱</option>
                  <option value="کاربر نمونه ۲">کاربر نمونه ۲</option>
                  <option value="کاربر نمونه ۳">کاربر نمونه ۳</option>
                </select>
                <div class="hint">کاربران این لیست تیکت را در کارتابل مشترک می‌بینند تا یکی آن را بردارد.</div>
              </div>
              <div class="checkbox">
                <input type="checkbox" id="ss_visible_to_all" name="ss_visible_to_all">
                <label for="ss_visible_to_all">تیکت برای همه افراد لیست نمایش داده شود تا یکی Claim کند.</label>
              </div>
            </div>

            <div class="strategy-card hidden" data-strategy="multi_send">
              <h4>تنظیمات ارسال همزمان</h4>
              <div class="row">
                <label for="multi_pool_users">لیست کاربران دریافت‌کننده اولیه</label>
                <select id="multi_pool_users" name="multi_pool_users" multiple>
                  <option value="کاربر نمونه ۱">کاربر نمونه ۱</option>
                  <option value="کاربر نمونه ۲">کاربر نمونه ۲</option>
                  <option value="کاربر نمونه ۳">کاربر نمونه ۳</option>
                </select>
                <div class="hint">تیکت به‌صورت همزمان در کارتابل این افراد نمایش داده می‌شود.</div>
              </div>
              <div class="row">
                <label for="multi_lock_mode">قانون قفل شدن تیکت</label>
                <select id="multi_lock_mode" name="multi_lock_mode">
                  <option value="first_picker_wins">اولین دریافت‌کننده مسئول می‌شود</option>
                </select>
              </div>
            </div>

            <div class="section-card">
              <h4>قوانین تکمیلی</h4>
              <div class="checkbox">
                <input type="checkbox" id="allow_manual_override" name="allow_manual_override">
                <label for="allow_manual_override">اجازه تغییر دستی مسئول در این Step فعال باشد.</label>
              </div>
              <div class="row">
                <label for="override_allowed_roles">نقش‌های مجاز برای تغییر دستی مسئول</label>
                <select id="override_allowed_roles" name="override_allowed_roles" multiple>
                  <option value="مدیر پروژه">مدیر پروژه</option>
                  <option value="سرگروه پشتیبانی">سرگروه پشتیبانی</option>
                </select>
                <div class="hint">فقط این نقش‌ها می‌توانند Assignee را در این استپ تغییر دهند.</div>
              </div>
              <div class="row">
                <label for="on_empty_pool_action">رفتار در صورت خالی بودن لیست کاندیدا</label>
                <select id="on_empty_pool_action" name="on_empty_pool_action">
                  <option value="keep_previous_assignee">نگه داشتن مسئول قبلی تیکت</option>
                  <option value="assign_to_project_manager">ارجاع به مدیر پروژه</option>
                  <option value="error_and_log">ثبت خطا و ارسال هشدار (بدون تغییر مسئول)</option>
                </select>
                <div class="hint">اگر به هر دلیل کاندیدایی برای ارجاع پیدا نشود، سیستم چه کاری انجام دهد.</div>
              </div>
            </div>
          </div>

          <div class="card">
            <h4>قوانین زمان‌بندی برای این استپ</h4>

            <div class="section-card">
              <h5>تنظیمات عمومی</h5>
              <div class="checkbox">
                <input type="checkbox" id="timing_enabled" name="timing_enabled">
                <label for="timing_enabled">فعال بودن قوانین زمان‌بندی برای این استپ</label>
              </div>
              <div class="row">
                <label for="timing_mode">نوع زمان‌سنجی</label>
                <select id="timing_mode" name="timing_mode">
                  <option value="calendar">بر اساس زمان تقویمی</option>
                  <option value="work_hours">بر اساس ساعت کاری</option>
                </select>
                <div class="hint">نوع محاسبه زمان برای این مرحله.</div>
              </div>
              <div class="checkbox">
                <input type="checkbox" id="timing_pause_on_hold" name="timing_pause_on_hold">
                <label for="timing_pause_on_hold">توقف زمان‌سنجی در حالت «تیکت متوقف / در انتظار»</label>
              </div>
            </div>

            <div class="section-card">
              <h5>سناریو ۱: تیکت باز نشده (Unread)</h5>
              <div class="checkbox">
                <input type="checkbox" id="timing_unread_enabled" name="timing_unread_enabled">
                <label for="timing_unread_enabled">فعال بودن این سناریو</label>
              </div>

              <div class="row">
                <label>حداکثر زمان مجاز برای باز نکردن تیکت</label>
                <div class="grid-2">
                  <input type="number" id="timing_unread_threshold_value" name="timing_unread_threshold_value" min="0" placeholder="مثلاً ۳۰">
                  <select id="timing_unread_threshold_unit" name="timing_unread_threshold_unit">
                    <option value="minute">دقیقه</option>
                    <option value="hour">ساعت</option>
                    <option value="day">روز</option>
                  </select>
                </div>
                <div class="hint">مثال: ۳۰ دقیقه یا ۲ ساعت.</div>
              </div>

              <div class="row">
                <label>اقدامات در صورت عبور از زمان</label>
                <div class="checkbox"><input type="checkbox" id="timing_unread_notify_receiver" name="timing_unread_notify_receiver"><label for="timing_unread_notify_receiver">ارسال پیامک/اعلان به دریافت‌کننده تیکت</label></div>
                <div class="checkbox"><input type="checkbox" id="timing_unread_notify_creator" name="timing_unread_notify_creator"><label for="timing_unread_notify_creator">ارسال پیامک/اعلان به ایجادکننده تیکت</label></div>
                <div class="checkbox"><input type="checkbox" id="timing_unread_notify_manager" name="timing_unread_notify_manager"><label for="timing_unread_notify_manager">ارسال پیامک/اعلان به مدیر تیکت‌ها / مدیر پروژه</label></div>
                <div class="checkbox"><input type="checkbox" id="timing_unread_return_prev" name="timing_unread_return_prev"><label for="timing_unread_return_prev">بازگشت خودکار تیکت به مرحله قبل</label></div>
                <div class="checkbox"><input type="checkbox" id="timing_unread_log_delay" name="timing_unread_log_delay"><label for="timing_unread_log_delay">ثبت این مورد در گزارش تاخیر</label></div>
                <div class="checkbox"><input type="checkbox" id="timing_unread_auto_assign_next" name="timing_unread_auto_assign_next"><label for="timing_unread_auto_assign_next">ارسال خودکار به نفر بعدی</label></div>
              </div>

              <div class="row hidden" id="timing_unread_next_users_wrap">
                <label for="timing_unread_next_users">لیست نفرات بعدی برای ارجاع</label>
                <select id="timing_unread_next_users" name="timing_unread_next_users" multiple>
                  <option value="کاربر نمونه ۱">کاربر نمونه ۱</option>
                  <option value="کاربر نمونه ۲">کاربر نمونه ۲</option>
                  <option value="کاربر نمونه ۳">کاربر نمونه ۳</option>
                </select>
                <div class="hint">ترتیب لیست نشان‌دهنده ترتیب پیشنهاد ارجاع است (در آینده می‌توان رفتار دقیق را پیاده کرد).</div>
              </div>
            </div>

            <div class="section-card">
              <h5>سناریو ۲: تیکت باز شده ولی تعیین‌تکلیف نشده</h5>
              <div class="checkbox">
                <input type="checkbox" id="timing_noaction_enabled" name="timing_noaction_enabled">
                <label for="timing_noaction_enabled">فعال بودن این سناریو</label>
              </div>

              <div class="row">
                <label>حداکثر زمان بدون تعیین‌تکلیف بعد از اولین باز شدن</label>
                <div class="grid-2">
                  <input type="number" id="timing_noaction_threshold_value" name="timing_noaction_threshold_value" min="0" placeholder="مثلاً ۴">
                  <select id="timing_noaction_threshold_unit" name="timing_noaction_threshold_unit">
                    <option value="hour">ساعت</option>
                    <option value="day">روز</option>
                  </select>
                </div>
                <div class="hint">مثال: ۴ ساعت یا ۱ روز بعد از اولین باز کردن.</div>
              </div>

              <div class="row">
                <label>اقدامات در صورت عبور از زمان</label>
                <div class="checkbox"><input type="checkbox" id="timing_noaction_log_delay" name="timing_noaction_log_delay"><label for="timing_noaction_log_delay">ثبت در گزارش تاخیر</label></div>
                <div class="checkbox"><input type="checkbox" id="timing_noaction_notify_creator" name="timing_noaction_notify_creator"><label for="timing_noaction_notify_creator">ارسال پیامک/اعلان به ایجادکننده تیکت</label></div>
                <div class="checkbox"><input type="checkbox" id="timing_noaction_notify_manager" name="timing_noaction_notify_manager"><label for="timing_noaction_notify_manager">ارسال پیامک/اعلان به مدیر تیکت‌ها / مدیر پروژه</label></div>
                <div class="checkbox"><input type="checkbox" id="timing_noaction_lock_other_tickets" name="timing_noaction_lock_other_tickets"><label for="timing_noaction_lock_other_tickets">قفل کردن دسترسی به سایر تیکت‌ها برای این کاربر (تا تعیین‌تکلیف)</label></div>
                <div class="checkbox"><input type="checkbox" id="timing_noaction_lock_mentions" name="timing_noaction_lock_mentions"><label for="timing_noaction_lock_mentions">محدودیت در منشن‌گذاری روی تیکت‌ها</label></div>
                <div class="checkbox"><input type="checkbox" id="timing_noaction_lock_conversation" name="timing_noaction_lock_conversation"><label for="timing_noaction_lock_conversation">محدودیت در ارسال پیام در گفتگوی تیکت</label></div>
              </div>
            </div>
          </div>
          <div class="card placeholder" aria-disabled="true">
            <h4>شرایط عبور مرحله</h4>
            <div>در آینده در این بخش تعیین می‌کنیم چه فیلدها و تأییدهایی قبل از عبور به مرحله بعد حتماً باید تکمیل شده باشند.</div>
          </div>
          <div class="card placeholder" aria-disabled="true">
            <h4>وابستگی به سایر تیکت‌ها یا مراحل</h4>
            <div>در آینده در این بخش مشخص می‌کنیم که عبور به مرحله بعد وابسته به تکمیل شدن کدام مراحل یا تیکت‌های دیگر باشد.</div>
          </div>
          <div class="card placeholder" aria-disabled="true">
            <h4>سطح دسترسی و دیدن تیکت</h4>
            <div>در آینده در این بخش تعیین می‌کنیم که در این مرحله چه نقش‌هایی تیکت را ببینند، ویرایش کنند یا فقط وضعیت را ببینند.</div>
          </div>
          <div class="card placeholder" aria-disabled="true">
            <h4>قوانین اعلان و اطلاع‌رسانی</h4>
            <div>در آینده در این بخش تعریف می‌کنیم روی چه رویدادهایی (ورود، خروج، تاخیر و…) چه اعلان‌هایی برای چه کسانی و از چه کانالی (نوتیف، پیامک، ایمیل) ارسال شود.</div>
          </div>
          <div class="card placeholder" aria-disabled="true">
            <h4>اقدامات خودکار</h4>
            <div>در آینده در این بخش تعیین می‌کنیم هنگام ورود/خروج این مرحله چه کارهای خودکار انجام شود (ساخت زیرتیکت، تغییر وضعیت، وب‌هوک و غیره).</div>
          </div>
          <div class="card placeholder" aria-disabled="true">
            <h4>سیاست بازگشایی تیکت</h4>
            <div>در آینده در این بخش مشخص می‌کنیم تیکت بعد از بازگشایی به کدام مرحله برگردد، چند بار مجاز به بازگشایی باشد و چه کسانی مجازند.</div>
          </div>
          <div class="card placeholder" aria-disabled="true">
            <h4>امتیازدهی و اولویت پویا</h4>
            <div>در آینده در این بخش قوانین امتیازدهی بر اساس تاخیر، ارجاع، بازگشایی و… و تغییر خودکار سطح اولویت را تعریف می‌کنیم.</div>
          </div>
          <div class="card placeholder" aria-disabled="true">
            <h4>پرچم‌گذاری برای ممیزی و گزارش‌ها</h4>
            <div>در آینده در این بخش تعریف می‌کنیم چه تیکت‌هایی بر اساس تاخیر، ارجاع زیاد، نارضایتی و… با پرچم‌های مختلف علامت‌گذاری شوند.</div>
          </div>
        </div>
      </section>
    </div>

    <div class="card">
      <h3>پیش‌نمایش تنظیمات فلو (JSON)</h3>
      <pre class="preview" id="json_preview"></pre>
    </div>
  </div>

  <script>
    const steps = [
      { id: "step_customer", name: "انتخاب کارفرما" },
      { id: "step_service", name: "انتخاب سرویس" },
      { id: "step_work", name: "انجام کار" },
      { id: "step_delivery", name: "تحویل به کارفرما" }
    ];

    const defaultAssignment = () => ({
      strategy_type: "single",
      candidate_source_type: "users",
      candidate_users: [],
      candidate_roles: [],
      single_assignment_mode: "fixed_user",
      single_fixed_user_id: "",
      rr_pool_users: [],
      rr_order_mode: "list_order",
      ss_pool_users: [],
      ss_visible_to_all: false,
      multi_pool_users: [],
      multi_lock_mode: "first_picker_wins",
      allow_manual_override: false,
      override_allowed_roles: [],
      on_empty_pool_action: "keep_previous_assignee"
    });

    function createDefaultTimingConfig() {
      return {
        enabled: false,
        time_mode: "calendar",
        pause_on_hold: false,
        unread: {
          enabled: false,
          threshold_value: null,
          threshold_unit: "minute",
          actions: {
            notify_receiver: false,
            notify_creator: false,
            notify_manager: false,
            return_to_previous_step: false,
            log_delay: false,
            auto_assign_next: false,
            next_users: []
          }
        },
        noDecision: {
          enabled: false,
          threshold_value: null,
          threshold_unit: "hour",
          actions: {
            log_delay: false,
            notify_creator: false,
            notify_manager: false,
            lock_other_tickets: false,
            lock_mentions: false,
            lock_conversation: false
          }
        }
      };
    }

    const flowConfig = {
      flowName: "",
      selectedStepId: steps[0].id,
      steps: steps.map(step => ({ id: step.id, name: step.name, assignment: defaultAssignment(), timing: createDefaultTimingConfig() }))
    };

    const elements = {
      stepItems: document.querySelectorAll('.step-item'),
      selectedLabel: document.getElementById('selected_step_label'),
      strategySelect: document.getElementById('strategy_type'),
      candidateUsers: document.getElementById('candidate_users'),
      candidateRoles: document.getElementById('candidate_roles'),
      candidateSourceRadios: document.querySelectorAll('input[name="candidate_source_type"]'),
      singleAssignmentMode: document.getElementById('single_assignment_mode'),
      singleFixedUser: document.getElementById('single_fixed_user_id'),
      rrPoolUsers: document.getElementById('rr_pool_users'),
      rrOrderMode: document.getElementById('rr_order_mode'),
      ssPoolUsers: document.getElementById('ss_pool_users'),
      ssVisibleToAll: document.getElementById('ss_visible_to_all'),
      multiPoolUsers: document.getElementById('multi_pool_users'),
      multiLockMode: document.getElementById('multi_lock_mode'),
      allowManualOverride: document.getElementById('allow_manual_override'),
      overrideAllowedRoles: document.getElementById('override_allowed_roles'),
      onEmptyPoolAction: document.getElementById('on_empty_pool_action'),
      strategyCards: document.querySelectorAll('[data-strategy]'),
      jsonPreview: document.getElementById('json_preview'),
      flowName: document.getElementById('flow_name'),
      timingEnabled: document.getElementById('timing_enabled'),
      timingMode: document.getElementById('timing_mode'),
      timingPauseOnHold: document.getElementById('timing_pause_on_hold'),
      timingUnreadEnabled: document.getElementById('timing_unread_enabled'),
      timingUnreadThresholdValue: document.getElementById('timing_unread_threshold_value'),
      timingUnreadThresholdUnit: document.getElementById('timing_unread_threshold_unit'),
      timingUnreadNotifyReceiver: document.getElementById('timing_unread_notify_receiver'),
      timingUnreadNotifyCreator: document.getElementById('timing_unread_notify_creator'),
      timingUnreadNotifyManager: document.getElementById('timing_unread_notify_manager'),
      timingUnreadReturnPrev: document.getElementById('timing_unread_return_prev'),
      timingUnreadLogDelay: document.getElementById('timing_unread_log_delay'),
      timingUnreadAutoAssignNext: document.getElementById('timing_unread_auto_assign_next'),
      timingUnreadNextUsers: document.getElementById('timing_unread_next_users'),
      timingUnreadNextUsersWrap: document.getElementById('timing_unread_next_users_wrap'),
      timingNoactionEnabled: document.getElementById('timing_noaction_enabled'),
      timingNoactionThresholdValue: document.getElementById('timing_noaction_threshold_value'),
      timingNoactionThresholdUnit: document.getElementById('timing_noaction_threshold_unit'),
      timingNoactionLogDelay: document.getElementById('timing_noaction_log_delay'),
      timingNoactionNotifyCreator: document.getElementById('timing_noaction_notify_creator'),
      timingNoactionNotifyManager: document.getElementById('timing_noaction_notify_manager'),
      timingNoactionLockOtherTickets: document.getElementById('timing_noaction_lock_other_tickets'),
      timingNoactionLockMentions: document.getElementById('timing_noaction_lock_mentions'),
      timingNoactionLockConversation: document.getElementById('timing_noaction_lock_conversation')
    };

    function getCurrentStep() {
      return flowConfig.steps.find(s => s.id === flowConfig.selectedStepId);
    }

    function setActiveStep(stepId) {
      flowConfig.selectedStepId = stepId;
      elements.stepItems.forEach(item => {
        item.classList.toggle('active', item.dataset.step === stepId);
      });
      const step = getCurrentStep();
      elements.selectedLabel.textContent = `مرحله: ${step.name}`;
      fillForm(step.assignment);
      fillTimingForm(step.timing);
      toggleStrategyCards(step.assignment.strategy_type);
      renderPreview();
    }

    function toggleStrategyCards(strategy) {
      elements.strategyCards.forEach(card => {
        card.classList.toggle('hidden', card.dataset.strategy !== strategy);
      });
    }

    function readMultiSelect(selectEl) {
      return Array.from(selectEl.selectedOptions).map(opt => opt.value);
    }

    function fillMultiSelect(selectEl, values) {
      Array.from(selectEl.options).forEach(opt => {
        opt.selected = values.includes(opt.value);
      });
    }

    function fillForm(assign) {
      elements.strategySelect.value = assign.strategy_type;
      elements.candidateSourceRadios.forEach(r => { r.checked = r.value === assign.candidate_source_type; });
      fillMultiSelect(elements.candidateUsers, assign.candidate_users);
      fillMultiSelect(elements.candidateRoles, assign.candidate_roles);
      elements.singleAssignmentMode.value = assign.single_assignment_mode;
      elements.singleFixedUser.value = assign.single_fixed_user_id;
      fillMultiSelect(elements.rrPoolUsers, assign.rr_pool_users);
      elements.rrOrderMode.value = assign.rr_order_mode;
      fillMultiSelect(elements.ssPoolUsers, assign.ss_pool_users);
      elements.ssVisibleToAll.checked = assign.ss_visible_to_all;
      fillMultiSelect(elements.multiPoolUsers, assign.multi_pool_users);
      elements.multiLockMode.value = assign.multi_lock_mode;
      elements.allowManualOverride.checked = assign.allow_manual_override;
      fillMultiSelect(elements.overrideAllowedRoles, assign.override_allowed_roles);
      elements.onEmptyPoolAction.value = assign.on_empty_pool_action;
    }

    function fillTimingForm(timing) {
      elements.timingEnabled.checked = timing.enabled;
      elements.timingMode.value = timing.time_mode;
      elements.timingPauseOnHold.checked = timing.pause_on_hold;

      elements.timingUnreadEnabled.checked = timing.unread.enabled;
      elements.timingUnreadThresholdValue.value = timing.unread.threshold_value ?? "";
      elements.timingUnreadThresholdUnit.value = timing.unread.threshold_unit;
      elements.timingUnreadNotifyReceiver.checked = timing.unread.actions.notify_receiver;
      elements.timingUnreadNotifyCreator.checked = timing.unread.actions.notify_creator;
      elements.timingUnreadNotifyManager.checked = timing.unread.actions.notify_manager;
      elements.timingUnreadReturnPrev.checked = timing.unread.actions.return_to_previous_step;
      elements.timingUnreadLogDelay.checked = timing.unread.actions.log_delay;
      elements.timingUnreadAutoAssignNext.checked = timing.unread.actions.auto_assign_next;
      fillMultiSelect(elements.timingUnreadNextUsers, timing.unread.actions.next_users);
      toggleUnreadNextUsers(timing.unread.actions.auto_assign_next);

      elements.timingNoactionEnabled.checked = timing.noDecision.enabled;
      elements.timingNoactionThresholdValue.value = timing.noDecision.threshold_value ?? "";
      elements.timingNoactionThresholdUnit.value = timing.noDecision.threshold_unit;
      elements.timingNoactionLogDelay.checked = timing.noDecision.actions.log_delay;
      elements.timingNoactionNotifyCreator.checked = timing.noDecision.actions.notify_creator;
      elements.timingNoactionNotifyManager.checked = timing.noDecision.actions.notify_manager;
      elements.timingNoactionLockOtherTickets.checked = timing.noDecision.actions.lock_other_tickets;
      elements.timingNoactionLockMentions.checked = timing.noDecision.actions.lock_mentions;
      elements.timingNoactionLockConversation.checked = timing.noDecision.actions.lock_conversation;
    }

    function updateAssignmentFromForm() {
      const step = getCurrentStep();
      const a = step.assignment;
      a.strategy_type = elements.strategySelect.value;
      a.candidate_source_type = document.querySelector('input[name="candidate_source_type"]:checked')?.value || "users";
      a.candidate_users = readMultiSelect(elements.candidateUsers);
      a.candidate_roles = readMultiSelect(elements.candidateRoles);
      a.single_assignment_mode = elements.singleAssignmentMode.value;
      a.single_fixed_user_id = elements.singleFixedUser.value;
      a.rr_pool_users = readMultiSelect(elements.rrPoolUsers);
      a.rr_order_mode = elements.rrOrderMode.value;
      a.ss_pool_users = readMultiSelect(elements.ssPoolUsers);
      a.ss_visible_to_all = elements.ssVisibleToAll.checked;
      a.multi_pool_users = readMultiSelect(elements.multiPoolUsers);
      a.multi_lock_mode = elements.multiLockMode.value;
      a.allow_manual_override = elements.allowManualOverride.checked;
      a.override_allowed_roles = readMultiSelect(elements.overrideAllowedRoles);
      a.on_empty_pool_action = elements.onEmptyPoolAction.value;
      toggleStrategyCards(a.strategy_type);
      renderPreview();
    }

    function toggleUnreadNextUsers(show) {
      elements.timingUnreadNextUsersWrap.classList.toggle('hidden', !show);
    }

    function toNullableNumber(value) {
      if (value === "" || value === null || value === undefined) return null;
      const num = Number(value);
      return Number.isNaN(num) ? null : num;
    }

    function updateTimingFromForm() {
      const step = getCurrentStep();
      const t = step.timing;
      t.enabled = elements.timingEnabled.checked;
      t.time_mode = elements.timingMode.value;
      t.pause_on_hold = elements.timingPauseOnHold.checked;

      t.unread.enabled = elements.timingUnreadEnabled.checked;
      t.unread.threshold_value = toNullableNumber(elements.timingUnreadThresholdValue.value);
      t.unread.threshold_unit = elements.timingUnreadThresholdUnit.value;
      t.unread.actions.notify_receiver = elements.timingUnreadNotifyReceiver.checked;
      t.unread.actions.notify_creator = elements.timingUnreadNotifyCreator.checked;
      t.unread.actions.notify_manager = elements.timingUnreadNotifyManager.checked;
      t.unread.actions.return_to_previous_step = elements.timingUnreadReturnPrev.checked;
      t.unread.actions.log_delay = elements.timingUnreadLogDelay.checked;
      t.unread.actions.auto_assign_next = elements.timingUnreadAutoAssignNext.checked;
      t.unread.actions.next_users = t.unread.actions.auto_assign_next ? readMultiSelect(elements.timingUnreadNextUsers) : [];
      toggleUnreadNextUsers(t.unread.actions.auto_assign_next);

      t.noDecision.enabled = elements.timingNoactionEnabled.checked;
      t.noDecision.threshold_value = toNullableNumber(elements.timingNoactionThresholdValue.value);
      t.noDecision.threshold_unit = elements.timingNoactionThresholdUnit.value;
      t.noDecision.actions.log_delay = elements.timingNoactionLogDelay.checked;
      t.noDecision.actions.notify_creator = elements.timingNoactionNotifyCreator.checked;
      t.noDecision.actions.notify_manager = elements.timingNoactionNotifyManager.checked;
      t.noDecision.actions.lock_other_tickets = elements.timingNoactionLockOtherTickets.checked;
      t.noDecision.actions.lock_mentions = elements.timingNoactionLockMentions.checked;
      t.noDecision.actions.lock_conversation = elements.timingNoactionLockConversation.checked;

      renderPreview();
    }

    function renderPreview() {
      flowConfig.flowName = elements.flowName.value;
      elements.jsonPreview.textContent = JSON.stringify(flowConfig, null, 2);
    }

    function attachListeners() {
      elements.stepItems.forEach(item => {
        item.addEventListener('click', () => setActiveStep(item.dataset.step));
      });

      elements.strategySelect.addEventListener('change', updateAssignmentFromForm);
      elements.candidateSourceRadios.forEach(r => r.addEventListener('change', updateAssignmentFromForm));
      [elements.candidateUsers, elements.candidateRoles, elements.rrPoolUsers, elements.ssPoolUsers, elements.multiPoolUsers, elements.overrideAllowedRoles].forEach(sel => {
        sel.addEventListener('change', updateAssignmentFromForm);
      });
      [elements.singleAssignmentMode, elements.singleFixedUser, elements.rrOrderMode, elements.multiLockMode, elements.onEmptyPoolAction].forEach(sel => sel.addEventListener('change', updateAssignmentFromForm));
      [elements.ssVisibleToAll, elements.allowManualOverride].forEach(chk => chk.addEventListener('change', updateAssignmentFromForm));
      elements.flowName.addEventListener('input', renderPreview);

      [
        elements.timingEnabled,
        elements.timingMode,
        elements.timingPauseOnHold,
        elements.timingUnreadEnabled,
        elements.timingUnreadThresholdValue,
        elements.timingUnreadThresholdUnit,
        elements.timingUnreadNotifyReceiver,
        elements.timingUnreadNotifyCreator,
        elements.timingUnreadNotifyManager,
        elements.timingUnreadReturnPrev,
        elements.timingUnreadLogDelay,
        elements.timingUnreadAutoAssignNext,
        elements.timingUnreadNextUsers,
        elements.timingNoactionEnabled,
        elements.timingNoactionThresholdValue,
        elements.timingNoactionThresholdUnit,
        elements.timingNoactionLogDelay,
        elements.timingNoactionNotifyCreator,
        elements.timingNoactionNotifyManager,
        elements.timingNoactionLockOtherTickets,
        elements.timingNoactionLockMentions,
        elements.timingNoactionLockConversation
      ].forEach(el => {
        if (!el) return;
        const evt = el.tagName === 'SELECT' || el.tagName === 'INPUT' ? (el.type === 'text' || el.type === 'number' ? 'input' : 'change') : 'change';
        el.addEventListener(evt, updateTimingFromForm);
      });
    }

    attachListeners();
    setActiveStep(flowConfig.selectedStepId);
    renderPreview();
  </script>
</body>
</html>
